---
import PageLayout from '../../../../layouts/PageLayout.astro';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../../../i18n/utils';
import { languages } from '../../../../i18n/index';
import ResearchCategoryCalculator from '../../../../components/calculators/ResearchCategoryCalculator';
import { ErrorBoundary } from '../../../../components/ErrorBoundary';
import type { ResearchTree } from '../../../../schemas/research';
import type { ImageMetadata } from 'astro';

// Mark this page as special for CSS scoping
const pageClass = 'page-research-calculator';

// Import validated research category data
import {
  allianceRecognition,
  unitSpecialTraining,
  fullyArmedAlliance,
  field,
  heroTraining,
  militaryStrategies,
  peaceShield,
  siegeToSeize,
} from '../../../../data/validated/research';
import '../../../../styles/shared-layouts.css';

// Import category images
import allianceRecognitionImg from '../../../../assets/images/research/alliance-recognition.png';
import unitSpecialTrainingImg from '../../../../assets/images/research/unit-special-training.png';
import fullyArmedAllianceImg from '../../../../assets/images/research/fully-armed-alliance.png';
import fieldImg from '../../../../assets/images/research/field.png';
import heroTrainingImg from '../../../../assets/images/research/hero-training.png';
import militaryStrategiesImg from '../../../../assets/images/research/military-strategies.png';
import peaceShieldImg from '../../../../assets/images/research/peace-shield.png';
import siegeToSeizeImg from '../../../../assets/images/research/siege-to-seize.png';

export function getStaticPaths() {
  const paths: { params: { lang: string | undefined; categoryId: string } }[] = [];
  const categoryIds = [
    'alliance_recognition',
    'unit_special_training',
    'fully_armed_alliance',
    'field',
    'hero_training',
    'military_strategies',
    'peace_shield',
    'siege_to_seize'
  ];

  // Generate paths for all languages
  Object.keys(languages).forEach(langKey => {
    const lang = langKey === 'en' ? undefined : langKey;
    categoryIds.forEach(categoryId => {
      paths.push({
        params: { lang, categoryId },
      });
    });
  });

  return paths;
}

// Map category data by ID
const researchDataMap: Record<string, ResearchTree> = {
  alliance_recognition: allianceRecognition,
  unit_special_training: unitSpecialTraining,
  fully_armed_alliance: fullyArmedAlliance,
  field: field,
  hero_training: heroTraining,
  military_strategies: militaryStrategies,
  peace_shield: peaceShield,
  siege_to_seize: siegeToSeize,
};

// Map category images by ID
const imageMap: Record<string, ImageMetadata> = {
  alliance_recognition: allianceRecognitionImg,
  unit_special_training: unitSpecialTrainingImg,
  fully_armed_alliance: fullyArmedAllianceImg,
  field: fieldImg,
  hero_training: heroTrainingImg,
  military_strategies: militaryStrategiesImg,
  peace_shield: peaceShieldImg,
  siege_to_seize: siegeToSeizeImg,
};

const { categoryId } = Astro.params;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);

const category = researchDataMap[categoryId];
const categoryImage = imageMap[categoryId];

if (!category) {
  return Astro.redirect(getLocalizedPath('tools/research', lang));
}
---

<PageLayout title={`${t(category.nameKey)} - Wild Hoggs`} description={`Calculate badge costs for ${t(category.nameKey)}`}>
  <div class="calculator-wrapper">
    <a href={getLocalizedPath('tools/research', lang)} class="back-link">
      {t('research.backToOverview')}
    </a>

    <ErrorBoundary lang={lang} client:load>
      <ResearchCategoryCalculator
        categoryData={category}
        categoryImageSrc={categoryImage.src}
        lang={lang}
        client:load
      />
    </ErrorBoundary>
  </div>
</PageLayout>

<script define:vars={{ pageClass }}>
  function applyPageClass() {
    document.body.classList.add(pageClass);
  }

  function removePageClass() {
    document.body.classList.remove(pageClass);
  }

  // Apply immediately on initial load
  applyPageClass();

  // Cleanup BEFORE swap to prevent flickering
  document.addEventListener('astro:before-swap', removePageClass);

  // Re-apply AFTER swap completes
  document.addEventListener('astro:after-swap', () => {
    if (window.location.pathname.includes('/tools/research/')) {
      applyPageClass();
    }
  });
</script>

<style is:global>
  /* Override page-content only when body has this specific class */
  body.page-research-calculator .page-content {
    overflow: hidden !important;
    overflow-y: hidden !important;
    overflow-x: hidden !important;
    padding: 0 !important;
    margin-top: 80px;
    height: calc(100vh - 80px);
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
  }

  @media (max-width: 768px) {
    body.page-research-calculator .page-content {
      margin-top: 70px;
      height: calc(100dvh - 70px);
    }
  }
</style>

<style>
  .calculator-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    padding: 1rem;
    gap: 0;
  }

  .back-link {
    display: inline-block;
    flex-shrink: 0;
    margin-bottom: 1rem;
    color: #ffa500;
    text-decoration: none;
    font-size: 0.95rem;
    transition: color 0.3s ease;
  }

  /* Make ResearchCategoryCalculator take remaining space */
  .calculator-wrapper > :global(*:last-child) {
    flex: 1;
    min-height: 0;
  }

  .back-link:hover {
    color: #ff8c00;
  }

  h1 {
    font-size: 2.5rem;
    color: #ffa500;
    margin-bottom: 0.5rem;
  }

  .subtitle {
    font-size: 1.2rem;
    color: rgba(255, 255, 255, 0.7);
  }

  @media (max-width: 768px) {
    h1 {
      font-size: 2rem;
    }

    .subtitle {
      font-size: 1rem;
    }
  }
</style>
