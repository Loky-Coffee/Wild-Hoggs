---
import PageLayout from '../../../../layouts/PageLayout.astro';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../../../i18n/utils';
import { languages, loadTranslations } from '../../../../i18n/index';
import type { TranslationKey } from '../../../../i18n/index';
import ResearchCategoryCalculator from '../../../../components/calculators/ResearchCategoryCalculator';
import { ErrorBoundary } from '../../../../components/ErrorBoundary';
import type { ResearchTree } from '../../../../schemas/research';
import type { ImageMetadata } from 'astro';

// Mark this page as special for CSS scoping
const pageClass = 'page-research-calculator';

// Import validated research category data
import {
  allianceRecognition,
  unitSpecialTraining,
  fullyArmedAlliance,
  field,
  heroTraining,
  militaryStrategies,
  peaceShield,
  siegeToSeize,
  armyBuilding,
} from '../../../../data/validated/research';
import '../../../../styles/shared-layouts.css';

// Import category images
import allianceRecognitionImg from '../../../../assets/images/research/alliance-recognition.webp';
import unitSpecialTrainingImg from '../../../../assets/images/research/unit-special-training.webp';
import fullyArmedAllianceImg from '../../../../assets/images/research/fully-armed-alliance.webp';
import fieldImg from '../../../../assets/images/research/field.webp';
import heroTrainingImg from '../../../../assets/images/research/hero-training.webp';
import militaryStrategiesImg from '../../../../assets/images/research/military-strategies.webp';
import peaceShieldImg from '../../../../assets/images/research/peace-shield.webp';
import siegeToSeizeImg from '../../../../assets/images/research/siege-to-seize.webp';
import armyBuildingImg from '../../../../assets/images/research/army-building.webp';

export function getStaticPaths() {
  const paths: { params: { lang: string | undefined; categoryId: string } }[] = [];
  const categoryIds = [
    'alliance_recognition',
    'unit_special_training',
    'fully_armed_alliance',
    'field',
    'hero_training',
    'military_strategies',
    'peace_shield',
    'siege_to_seize',
    'army_building',
  ];

  // Generate paths for all languages
  Object.keys(languages).forEach(langKey => {
    const lang = langKey === 'en' ? undefined : langKey;
    categoryIds.forEach(categoryId => {
      paths.push({
        params: { lang, categoryId },
      });
    });
  });

  return paths;
}

// Map category data by ID
const researchDataMap: Record<string, ResearchTree> = {
  alliance_recognition: allianceRecognition,
  unit_special_training: unitSpecialTraining,
  fully_armed_alliance: fullyArmedAlliance,
  field: field,
  hero_training: heroTraining,
  military_strategies: militaryStrategies,
  peace_shield: peaceShield,
  siege_to_seize: siegeToSeize,
  army_building: armyBuilding,
};

// Map category images by ID
const imageMap: Record<string, ImageMetadata> = {
  alliance_recognition: allianceRecognitionImg,
  unit_special_training: unitSpecialTrainingImg,
  fully_armed_alliance: fullyArmedAllianceImg,
  field: fieldImg,
  hero_training: heroTrainingImg,
  military_strategies: militaryStrategiesImg,
  peace_shield: peaceShieldImg,
  siege_to_seize: siegeToSeizeImg,
  army_building: armyBuildingImg,
};

const { categoryId } = Astro.params;
const lang = getLangFromUrl(Astro.url);
const translationData = await loadTranslations(lang);
const t = useTranslations(translationData);

const category = researchDataMap[categoryId];
const categoryImage = imageMap[categoryId];

if (!category) {
  return Astro.redirect(getLocalizedPath('tools/research', lang));
}

const breadcrumbItems = [
  { label: t('nav.home'), href: getLocalizedPath('', lang) },
  { label: t('nav.tools'), href: getLocalizedPath('tools', lang) },
  { label: t('tools.research.title'), href: getLocalizedPath('tools/research', lang) },
  { label: t(category.nameKey) }
];
---

<PageLayout title={`Last Z ${t(category.nameKey as TranslationKey)}`} description={`Calculate Last Z badge costs for ${t(category.nameKey as TranslationKey)} research`} breadcrumbs={breadcrumbItems}>
  <h1 class="page-title-subtle">{t(category.nameKey as TranslationKey)}</h1>
  <div class="calculator-wrapper">
    <ErrorBoundary lang={lang} client:load>
      <ResearchCategoryCalculator
        categoryData={category}
        categoryImageSrc={categoryImage.src}
        lang={lang}
        translationData={translationData}
        client:load
      />
    </ErrorBoundary>
  </div>
</PageLayout>

<script define:vars={{ pageClass }}>
  function applyPageClass() {
    document.body.classList.add(pageClass);
  }

  function removePageClass() {
    document.body.classList.remove(pageClass);
  }

  // Apply immediately on initial load
  applyPageClass();

  // Cleanup BEFORE swap to prevent flickering
  document.addEventListener('astro:before-swap', removePageClass);

  // Re-apply AFTER swap completes
  document.addEventListener('astro:after-swap', () => {
    if (window.location.pathname.includes('/tools/research/')) {
      applyPageClass();
    }
  });
</script>

<style is:global>
  /* Override page-content only when body has this specific class */
  body.page-research-calculator .page-content {
    overflow: hidden !important;
    overflow-y: hidden !important;
    overflow-x: hidden !important;
    padding: 0 !important;
    height: calc(100dvh - var(--sticky-offset));
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
  }
</style>

<style>
  .page-title-subtle {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.3);
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 0;
    padding: 0.4rem 1rem 0;
  }

  .calculator-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    padding: 1rem;
    gap: 0;
  }

  /* Make ResearchCategoryCalculator take remaining space */
  .calculator-wrapper > :global(*:last-child) {
    flex: 1;
    min-height: 0;
  }
</style>
