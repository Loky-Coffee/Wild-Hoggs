---
import PageLayout from '../../../layouts/PageLayout.astro';
import { getLangFromUrl, useTranslations, getLocalizedPath } from '../../../i18n/utils';
import { getLanguagePaths } from '../../../i18n/static-paths';
import { loadTranslations } from '../../../i18n/index';
import TankCalculator from '../../../components/calculators/TankCalculator';
import { ErrorBoundary } from '../../../components/ErrorBoundary';
import '../../../styles/shared-layouts.css';

// Mark this page as special for CSS scoping
const pageClass = 'page-tank-calculator';

export function getStaticPaths() {
  return getLanguagePaths();
}

const lang = getLangFromUrl(Astro.url);
const translationData = await loadTranslations(lang);
const t = useTranslations(translationData);

const breadcrumbItems = [
  { label: t('nav.home'), href: getLocalizedPath('', lang) },
  { label: t('nav.tools'), href: getLocalizedPath('tools', lang) },
  { label: t('tools.tank.title') }
];
---

<PageLayout
  title={t('tools.tank.title')}
  description={t('tools.tank.description')}
  breadcrumbs={breadcrumbItems}
  image="/og-garage.webp"
  imageAlt={t('tools.tank.title')}
>
  <h1 class="page-title-subtle">{t('tools.tank.title')}</h1>
  <div class="calculator-wrapper">
    <ErrorBoundary lang={lang} client:load>
      <TankCalculator lang={lang} translationData={translationData} client:load />
    </ErrorBoundary>
  </div>
</PageLayout>

<script define:vars={{ pageClass }}>
  function applyPageClass() {
    document.body.classList.add(pageClass);
  }

  function removePageClass() {
    document.body.classList.remove(pageClass);
  }

  // Apply immediately on initial load
  applyPageClass();

  // Cleanup BEFORE swap to prevent flickering
  document.addEventListener('astro:before-swap', removePageClass);

  // Re-apply AFTER swap completes
  document.addEventListener('astro:after-swap', () => {
    if (window.location.pathname.includes('/tools/tank')) {
      applyPageClass();
    }
  });
</script>

<style is:global>
  /* Override page-content only when body has this specific class */
  body.page-tank-calculator .page-content {
    overflow: hidden !important;
    overflow-y: hidden !important;
    overflow-x: hidden !important;
    padding: 0 !important;
    height: calc(100dvh - var(--sticky-offset));
    display: flex;
    flex-direction: column;
    box-sizing: border-box;
  }
</style>

<style>
  .page-title-subtle {
    font-size: 0.75rem;
    color: rgba(255, 255, 255, 0.3);
    font-weight: 400;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin: 0;
    padding: 0.4rem 1rem 0;
  }

  .calculator-wrapper {
    display: flex;
    flex-direction: column;
    flex: 1;
    min-height: 0;
    padding: 1rem;
    gap: 0;
  }

  /* Make TankCalculator take remaining space */
  .calculator-wrapper > :global(*:last-child) {
    flex: 1;
    min-height: 0;
  }
</style>
