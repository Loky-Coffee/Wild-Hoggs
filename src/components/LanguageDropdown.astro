---
import { languages } from '../i18n/index';
import { getLangFromUrl } from '../i18n/utils';

const currentLang = getLangFromUrl(Astro.url);

// Language codes to flag emojis mapping
const flags: Record<string, string> = {
  de: 'ðŸ‡©ðŸ‡ª',
  en: 'ðŸ‡¬ðŸ‡§',
  fr: 'ðŸ‡«ðŸ‡·',
  ko: 'ðŸ‡°ðŸ‡·',
  th: 'ðŸ‡¹ðŸ‡­',
  ja: 'ðŸ‡¯ðŸ‡µ',
  pt: 'ðŸ‡µðŸ‡¹',
  es: 'ðŸ‡ªðŸ‡¸',
  tr: 'ðŸ‡¹ðŸ‡·',
  id: 'ðŸ‡®ðŸ‡©',
  'zh-TW': 'ðŸ‡¹ðŸ‡¼',
  'zh-CN': 'ðŸ‡¨ðŸ‡³',
  it: 'ðŸ‡®ðŸ‡¹',
  ar: 'ðŸ‡¸ðŸ‡¦',
  vi: 'ðŸ‡»ðŸ‡³',
};

// Generate language URLs
const getLanguageUrl = (targetLang: string) => {
  const currentPath = Astro.url.pathname;

  // Remove language prefix if exists (excluding 'en' which has no prefix now)
  const pathWithoutLang = currentPath.replace(/^\/(de|fr|ko|th|ja|pt|es|tr|id|zh-TW|zh-CN|it|ar|vi)(\/|$)/, '/');

  // English has no prefix (root)
  if (targetLang === 'en') {
    return pathWithoutLang === '' ? '/' : pathWithoutLang;
  }

  // Other languages get prefix
  return `/${targetLang}${pathWithoutLang === '/' ? '/' : pathWithoutLang}`;
};
---

<nav class="language-dropdown" aria-label="Language selection">
  <button class="dropdown-toggle" aria-label="Select language" aria-haspopup="true" aria-expanded="false">
    <span class="flag">{flags[currentLang]}</span>
    <span class="lang-name">{languages[currentLang]}</span>
    <span class="arrow">â–¼</span>
  </button>

  <div class="dropdown-menu">
    {Object.entries(languages).map(([code, name]) => (
      <a
        href={getLanguageUrl(code)}
        class:list={['dropdown-item', { active: currentLang === code }]}
        aria-current={currentLang === code ? 'true' : undefined}
        data-lang={code}
      >
        <span class="flag">{flags[code]}</span>
        <span class="lang-name">{name}</span>
        {currentLang === code && <span class="check">âœ“</span>}
      </a>
    ))}
  </div>
</nav>

<style>
  .language-dropdown {
    position: relative;
    display: inline-block;
  }

  .dropdown-toggle {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem 1rem;
    background: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 165, 0, 0.3);
    border-radius: 8px;
    color: #ffa500;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
    font-size: 0.95rem;
  }

  .dropdown-toggle:hover {
    background: rgba(255, 165, 0, 0.2);
    border-color: rgba(255, 165, 0, 0.6);
    transform: translateY(-2px);
  }

  .dropdown-toggle .flag {
    font-size: 1.2rem;
    line-height: 1;
  }

  .dropdown-toggle .arrow {
    font-size: 0.7rem;
    transition: transform 0.3s ease;
    margin-left: 0.25rem;
  }

  .dropdown-toggle[aria-expanded="true"] .arrow {
    transform: rotate(180deg);
  }

  .dropdown-menu {
    position: absolute;
    top: calc(100% + 0.5rem);
    right: 0;
    min-width: 200px;
    max-height: 400px;
    overflow-y: auto;
    background: rgba(26, 26, 26, 0.98);
    border: 2px solid rgba(255, 165, 0, 0.3);
    border-radius: 12px;
    backdrop-filter: blur(10px);
    opacity: 0;
    visibility: hidden;
    transform: translateY(-10px);
    transition: all 0.3s ease;
    z-index: 1000;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
  }

  .language-dropdown.open .dropdown-menu {
    opacity: 1;
    visibility: visible;
    transform: translateY(0);
  }

  .dropdown-item {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    padding: 0.75rem 1rem;
    color: rgba(255, 255, 255, 0.9);
    text-decoration: none;
    transition: all 0.2s ease;
    border-bottom: 1px solid rgba(255, 165, 0, 0.1);
  }

  .dropdown-item:last-child {
    border-bottom: none;
  }

  .dropdown-item:hover {
    background: rgba(255, 165, 0, 0.15);
    color: #ffa500;
  }

  .dropdown-item.active {
    background: rgba(255, 165, 0, 0.2);
    color: #ffa500;
    font-weight: 600;
  }

  .dropdown-item .flag {
    font-size: 1.3rem;
    line-height: 1;
  }

  .dropdown-item .lang-name {
    flex: 1;
    font-size: 0.95rem;
  }

  .dropdown-item .check {
    color: #4caf50;
    font-weight: bold;
    font-size: 1.1rem;
  }

  /* Scrollbar styling */
  .dropdown-menu::-webkit-scrollbar {
    width: 8px;
  }

  .dropdown-menu::-webkit-scrollbar-track {
    background: rgba(0, 0, 0, 0.2);
    border-radius: 8px;
  }

  .dropdown-menu::-webkit-scrollbar-thumb {
    background: rgba(255, 165, 0, 0.4);
    border-radius: 8px;
  }

  .dropdown-menu::-webkit-scrollbar-thumb:hover {
    background: rgba(255, 165, 0, 0.6);
  }

  /* Mobile responsive */
  @media (max-width: 768px) {
    .dropdown-toggle {
      padding: 0.4rem 0.8rem;
      font-size: 0.85rem;
    }

    .dropdown-toggle .lang-name {
      display: none;
    }

    .dropdown-menu {
      right: 0;
      left: auto;
      min-width: 180px;
    }

    .dropdown-item {
      padding: 0.6rem 0.8rem;
    }

    .dropdown-item .lang-name {
      font-size: 0.9rem;
    }
  }

  /* RTL Support for Arabic */
  .dropdown-item[href*="/ar"] {
    direction: rtl;
  }
</style>

<script>
  const dropdownClickHandlers = new WeakMap<Element, EventListener>();
  const dropdownOutsideHandlers = new WeakMap<Element, EventListener>();
  const dropdownMenuKeydownHandlers = new WeakMap<Element, EventListener>();
  const dropdownDocumentKeydownHandlers = new WeakMap<Element, EventListener>();

  function setupLanguageDropdown() {
    const dropdown = document.querySelector('.language-dropdown');
    const toggle = dropdown?.querySelector('.dropdown-toggle');
    const menu = dropdown?.querySelector('.dropdown-menu');

    if (!dropdown || !toggle || !menu) return;

    // Remove old listeners if they exist
    const oldClickHandler = dropdownClickHandlers.get(toggle);
    if (oldClickHandler) {
      toggle.removeEventListener('click', oldClickHandler);
    }
    const oldOutsideHandler = dropdownOutsideHandlers.get(toggle);
    if (oldOutsideHandler) {
      document.removeEventListener('click', oldOutsideHandler);
    }
    const oldMenuKeydownHandler = dropdownMenuKeydownHandlers.get(menu);
    if (oldMenuKeydownHandler) {
      menu.removeEventListener('keydown', oldMenuKeydownHandler);
    }
    const oldDocumentKeydownHandler = dropdownDocumentKeydownHandlers.get(dropdown);
    if (oldDocumentKeydownHandler) {
      document.removeEventListener('keydown', oldDocumentKeydownHandler);
    }

    // Toggle dropdown
    const clickHandler = (e: Event) => {
      e.stopPropagation();
      const isOpen = dropdown.classList.toggle('open');
      toggle.setAttribute('aria-expanded', String(isOpen));
    };

    // Close on outside click
    const outsideHandler = (e: Event) => {
      if (!dropdown.contains(e.target as Node)) {
        dropdown.classList.remove('open');
        toggle.setAttribute('aria-expanded', 'false');
      }
    };

    // Keyboard navigation (Escape + ArrowUp/Down for ARIA menu pattern)
    const menuKeydownHandler: EventListener = (e) => {
      const ke = e as KeyboardEvent;
      const items = Array.from(menu.querySelectorAll<HTMLElement>('.dropdown-item'));
      const current = document.activeElement as HTMLElement;
      const idx = items.indexOf(current);

      if (ke.key === 'ArrowDown') {
        ke.preventDefault();
        items[(idx + 1) % items.length]?.focus();
      } else if (ke.key === 'ArrowUp') {
        ke.preventDefault();
        items[(idx - 1 + items.length) % items.length]?.focus();
      } else if (ke.key === 'Home') {
        ke.preventDefault();
        items[0]?.focus();
      } else if (ke.key === 'End') {
        ke.preventDefault();
        items[items.length - 1]?.focus();
      } else if (ke.key === 'Escape') {
        dropdown.classList.remove('open');
        toggle.setAttribute('aria-expanded', 'false');
        (toggle as HTMLElement).focus();
      }
    };

    // Close on escape key (also when focus is outside menu)
    const documentKeydownHandler: EventListener = (e) => {
      const ke = e as KeyboardEvent;
      if (ke.key === 'Escape' && dropdown.classList.contains('open')) {
        dropdown.classList.remove('open');
        toggle.setAttribute('aria-expanded', 'false');
        (toggle as HTMLElement).focus();
      }
    };

    // Store all handlers for cleanup on next call
    dropdownClickHandlers.set(toggle, clickHandler);
    dropdownOutsideHandlers.set(toggle, outsideHandler);
    dropdownMenuKeydownHandlers.set(menu, menuKeydownHandler);
    dropdownDocumentKeydownHandlers.set(dropdown, documentKeydownHandler);

    // Add listeners
    toggle.addEventListener('click', clickHandler);
    document.addEventListener('click', outsideHandler);
    menu.addEventListener('keydown', menuKeydownHandler);
    document.addEventListener('keydown', documentKeydownHandler);

    // Save language preference when user clicks a language item
    menu.querySelectorAll<HTMLElement>('.dropdown-item[data-lang]').forEach(item => {
      item.addEventListener('click', () => {
        const lang = item.getAttribute('data-lang');
        const token = localStorage.getItem('wh-auth-token');
        if (!lang || !token) return;

        // Update localStorage immediately so all islands react before navigation
        const storedUser = localStorage.getItem('wh-auth-user');
        if (storedUser) {
          try {
            const userObj = JSON.parse(storedUser);
            userObj.language = lang;
            localStorage.setItem('wh-auth-user', JSON.stringify(userObj));
            window.dispatchEvent(new CustomEvent('wh-auth-change', {
              detail: { user: userObj, token },
            }));
          } catch { /* ignore */ }
        }

        // Persist to DB in background
        fetch('/api/user/profile', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
          body: JSON.stringify({ language: lang }),
        }).catch(() => { /* ignore */ });
      });
    });
  }

  // Run on initial load
  document.addEventListener('DOMContentLoaded', setupLanguageDropdown);

  // Run on View Transitions
  document.addEventListener('astro:page-load', setupLanguageDropdown);
</script>
