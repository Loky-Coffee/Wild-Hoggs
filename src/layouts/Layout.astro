---
import { ViewTransitions } from 'astro:transitions';
import { getLangFromUrl } from '../i18n/utils';
import { languages } from '../i18n/index';
import '../styles/design-tokens.css';

interface Props {
  title: string;
  description?: string;
  image?: string;
  imageAlt?: string;
  robots?: string;
}

const {
  title,
  description = 'Complete Last Z guide with heroes tier lists, alliance strategies, event tips & calculator tools. From beginner to advanced. Updated 2026!',
  image = '/og-image.webp',
  imageAlt = 'Wild Hoggs Guild Logo',
  robots = 'index, follow'
} = Astro.props;
const lang = getLangFromUrl(Astro.url);

const siteUrl = Astro.site || new URL('https://wild-hoggs.com/');
const canonicalURL = new URL(Astro.url.pathname, siteUrl);
const ogImageURL = new URL(image, siteUrl);

function getAlternateURL(targetLang: string): URL {
  const currentPath = Astro.url.pathname;

  if (targetLang === 'en') {
    const pathWithoutLang = currentPath.replace(/^\/(de|fr|ko|th|ja|pt|es|tr|id|zh-TW|zh-CN|it|ar|vi)(\/|$)/, '/');
    return new URL(pathWithoutLang === '' ? '/' : pathWithoutLang, siteUrl);
  }

  if (lang === 'en') {
    return new URL(`/${targetLang}${currentPath === '/' ? '' : currentPath}`, siteUrl);
  } else {
    const pathWithoutLang = currentPath.replace(/^\/(de|fr|ko|th|ja|pt|es|tr|id|zh-TW|zh-CN|it|ar|vi)(\/|$)/, '/');
    return new URL(`/${targetLang}${pathWithoutLang === '/' ? '' : pathWithoutLang}`, siteUrl);
  }
}

const alternateURLs = Object.keys(languages).reduce((acc, langCode) => {
  acc[langCode] = getAlternateURL(langCode);
  return acc;
}, {} as Record<string, URL>);

const xDefaultURL = alternateURLs['en'] || alternateURLs[lang] || canonicalURL;

const hreflangTags = Object.entries(alternateURLs).map(([langCode, url]) => ({
  langCode,
  url: url.toString()
}));

const organizationSchema = {
  '@context': 'https://schema.org',
  '@type': 'Organization',
  name: 'Wild Hoggs',
  description: description,
  url: canonicalURL.toString(),
  logo: new URL('/favicon.svg', siteUrl).toString(),
  sameAs: []
};

const localeMap: Record<string, string> = {
  'en': 'en_US',
  'de': 'de_DE',
  'fr': 'fr_FR',
  'es': 'es_ES',
  'pt': 'pt_PT',
  'it': 'it_IT',
  'tr': 'tr_TR',
  'ja': 'ja_JP',
  'ko': 'ko_KR',
  'zh-CN': 'zh_CN',
  'zh-TW': 'zh_TW',
  'th': 'th_TH',
  'id': 'id_ID',
  'ar': 'ar_AR',
  'vi': 'vi_VN'
};

const currentLocale = localeMap[lang] || 'en_US';
const alternateLocales = Object.keys(languages)
  .filter(l => l != lang)
  .map(l => localeMap[l] || 'en_US');

const ogLocaleAlternateTags = alternateLocales.map(locale => ({ locale }));

const searchPath = lang === 'en' ? '/tools' : `/${lang}/tools`;
const websiteSchema = {
  '@context': 'https://schema.org',
  '@type': 'WebSite',
  name: 'Wild Hoggs',
  url: siteUrl.toString(),
  inLanguage: Object.values(localeMap),
  potentialAction: {
    '@type': 'SearchAction',
    target: {
      '@type': 'EntryPoint',
      urlTemplate: `${siteUrl}${searchPath}?q={search_term_string}`
    },
    'query-input': 'required name=search_term_string'
  }
};
---

<!doctype html>
<html lang={lang}>
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content={robots} />
    <meta name="theme-color" content="#ffa500" />
    <meta name="author" content="Wild Hoggs Guild" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>

    <style>
      html {
        background: #1a1a1a;
      }
      body {
        background: linear-gradient(135deg, #1a1a1a 0%, #2d1b00 100%);
        margin: 0;
        padding: 0;
        min-height: 100vh;
      }
    </style>

    <script is:inline>
      (function () {
        if (window.location.pathname !== '/') return;
        if (localStorage.getItem('wh-lang-redirected')) return;
        var full = navigator.language;
        var short = full.split('-')[0];
        var lang = null;
        if (short === 'zh') {
          lang = (full === 'zh-TW' || full === 'zh-Hant') ? 'zh-TW' : 'zh-CN';
        } else {
          var supported = ['de', 'fr', 'ko', 'th', 'ja', 'pt', 'es', 'tr', 'id', 'it', 'ar', 'vi'];
          if (short !== 'en' && supported.indexOf(short) !== -1) lang = short;
        }
        if (lang) {
          localStorage.setItem('wh-lang-redirected', '1');
          window.location.replace('/' + lang);
        }
      })();
    </script>
    <ViewTransitions />
    <link rel="canonical" href={canonicalURL} />
    {hreflangTags.map(({ langCode, url }) => (
      <link rel="alternate" hreflang={langCode} href={url} />
    ))}
    <link rel="alternate" hreflang="x-default" href={xDefaultURL} />

    <meta property="og:type" content="website" />
    <meta property="og:url" content={canonicalURL} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={ogImageURL} />
    <meta property="og:image:type" content="image/webp" />
    <meta property="og:image:width" content="1200" />
    <meta property="og:image:height" content="630" />
    <meta property="og:image:alt" content={imageAlt} />
    <meta property="og:locale" content={currentLocale} />
    {ogLocaleAlternateTags.map(({ locale }) => (
      <meta property="og:locale:alternate" content={locale} />
    ))}
    <meta property="og:site_name" content="Wild Hoggs" />

    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={canonicalURL} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={ogImageURL} />
    <meta property="twitter:image:alt" content={imageAlt} />

    <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
    <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
  </head>
  <body>
    <slot />
  </body>
</html>

<style is:global>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }

  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    background: linear-gradient(135deg, var(--color-bg-gradient-start) 0%, var(--color-bg-gradient-end) 100%);
    color: var(--color-text);
    min-height: 100dvh;
  }
</style>
